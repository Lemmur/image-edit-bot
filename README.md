# ๐จ Qwen Image Edit Bot

Telegram-ะฑะพั ะดะปั ัะตะดะฐะบัะธัะพะฒะฐะฝะธั ะธะทะพะฑัะฐะถะตะฝะธะน ั ะฟะพะผะพััั AI ะผะพะดะตะปะธ **Qwen Image Edit** ัะตัะตะท **ComfyUI**.

ะะพะปัะทะพะฒะฐัะตะปั ะพัะฟัะฐะฒะปัะตั ัะพัะพ + ัะตะบััะพะฒะพะต ะพะฟะธัะฐะฝะธะต ะธะทะผะตะฝะตะฝะธะน โ ะฑะพั ะพะฑัะฐะฑะฐััะฒะฐะตั ัะตัะตะท ComfyUI โ ะพัะฟัะฐะฒะปัะตั ัะตะทัะปััะฐั ะพะฑัะฐัะฝะพ.

---

## ๐๏ธ ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั

```
โโโโโโโโโโโโโโโ        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Telegram    โ        โ  GPU Server (Ubuntu + RTX 3090)          โ
โ  User        โโโโโโโโโบโ                                          โ
โ              โ  Bot   โ  โโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโ  โ
โ  ๐ธ + ๐    โ  API   โ  โ Telegram   โโโโโโบโ ComfyUI         โ  โ
โ              โ        โ  โ Bot        โโโโโโโ API :8188       โ  โ
โ  โ ๐ผ๏ธ       โ        โ  โ (aiogram)  โ     โ Qwen Model      โ  โ
โ              โ        โ  โโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโ        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

1. ะะพะปัะทะพะฒะฐัะตะปั ะพัะฟัะฐะฒะปัะตั ะฑะพัั **ัะพัะพ** + **ะฟัะพะผะฟั** (ะพะฟะธัะฐะฝะธะต ะธะทะผะตะฝะตะฝะธะน)
2. ะะพั ัะบะฐัะธะฒะฐะตั ัะพัะพ, ัะพะทะดะฐัั ะทะฐะดะฐัั, ััะฐะฒะธั ะฒ ะพัะตัะตะดั
3. TaskProcessor ะทะฐะณััะถะฐะตั ัะพัะพ ะฒ ComfyUI, ะฟะพะดััะฐะฒะปัะตั ะฟะฐัะฐะผะตััั ะฒ workflow
4. ComfyUI ะฒัะฟะพะปะฝัะตั inference ะฝะฐ GPU (Qwen Image Edit ะผะพะดะตะปั)
5. ะะพั ะฟะพะปััะฐะตั ัะตะทัะปััะฐั ะธ ะพัะฟัะฐะฒะปัะตั ะฟะพะปัะทะพะฒะฐัะตะปั

**ะะพะดะตะปะธ ะบััะธัััััั** โ ะฟะตัะฒัะน ะทะฐะฟััะบ ~30 ัะตะบ (ะทะฐะณััะทะบะฐ ะฒ VRAM), ะฟะพัะปะตะดัััะธะต ~5-15 ัะตะบ.

---

## โก ะะพะทะผะพะถะฝะพััะธ

- ๐ธ ะะตะดะฐะบัะธัะพะฒะฐะฝะธะต ะธะทะพะฑัะฐะถะตะฝะธะน ะฟะพ ัะตะบััะพะฒะพะผั ะพะฟะธัะฐะฝะธั
- ๐๏ธ ะะพะปะฝัะน ะบะพะฝััะพะปั ะฟะฐัะฐะผะตััะพะฒ: steps, seed, CFG, sampler, scheduler, strength
- ๐ ะััะปะตะถะธะฒะฐะฝะธะต ะฟัะพะณัะตััะฐ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
- ๐ ะะพะดะดะตัะถะบะฐ photo ะธ document (document ัะพััะฐะฝัะตั ะพัะธะณะธะฝะฐะปัะฝะพะต ะบะฐัะตััะฒะพ)
- ๐ FIFO ะพัะตัะตะดั ะทะฐะดะฐั (ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ)
- โป๏ธ ะะฒัะพะพัะธััะบะฐ ะฒัะตะผะตะฝะฝัั ัะฐะนะปะพะฒ
- ๐ Whitelist ะฟะพะปัะทะพะฒะฐัะตะปะตะน
- ๐ ะะฒัะพะฟะตัะตะทะฐะฟััะบ ะฟัะธ ัะฑะพัั (systemd)

---

## ๐ ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
image-edit-bot/
โโโ .env.example           # ะจะฐะฑะปะพะฝ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั
โโโ config.yaml            # ะะพะฝัะธะณััะฐัะธั (ะฟะฐัะฐะผะตััั workflow, ะปะธะผะธัั)
โโโ requirements.txt       # Python ะทะฐะฒะธัะธะผะพััะธ
โโโ workflows/
โ   โโโ qwen_image_edit.json   # Workflow ะฒ API-ัะพัะผะฐัะต
โโโ src/
โ   โโโ main.py            # ะขะพัะบะฐ ะฒัะพะดะฐ
โ   โโโ bot/               # Telegram ะฑะพั (handlers, keyboards, FSM)
โ   โโโ comfyui/           # ComfyUI ะบะปะธะตะฝั (REST + WebSocket)
โ   โโโ queue/             # ะัะตัะตะดั ะทะฐะดะฐั (FIFO)
โ   โโโ models/            # ะะพะดะตะปะธ ะดะฐะฝะฝัั (Task, Config)
โ   โโโ storage/           # ะฃะฟัะฐะฒะปะตะฝะธะต ัะฐะนะปะฐะผะธ
โ   โโโ utils/             # ะฃัะธะปะธัั (config, logger)
โโโ scripts/               # ะกะบัะธะฟัั ัััะฐะฝะพะฒะบะธ ัะตัะฒะตัะฐ
โโโ systemd/               # Systemd ัะตัะฒะธัั
โโโ data/                  # ะะฐะฑะพัะธะต ะดะฐะฝะฝัะต (input/output/temp)
โโโ logs/                  # ะะพะณะธ
โโโ tests/                 # ะขะตััั
โโโ plans/                 # ะััะธัะตะบัััะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั
```

---

## ๐๏ธ ะขะตัะฝะพะปะพะณะธัะตัะบะธะน ััะตะบ

| ะะพะผะฟะพะฝะตะฝั | ะขะตัะฝะพะปะพะณะธั | ะะฐะทะฝะฐัะตะฝะธะต |
|-----------|-----------|------------|
| Telegram Bot | `aiogram 3.x` | Async ะฑะพั-ััะตะนะผะฒะพัะบ ั FSM |
| HTTP Client | `aiohttp` | REST ะทะฐะฟัะพัั ะบ ComfyUI |
| WebSocket | `websockets` | ะัะพะณัะตัั ะณะตะฝะตัะฐัะธะธ |
| Config | `pydantic` + `PyYAML` | ะะฐะปะธะดะฐัะธั ะบะพะฝัะธะณััะฐัะธะธ |
| Logging | `loguru` | ะกัััะบัััะธัะพะฒะฐะฝะฝัะต ะปะพะณะธ |
| Image | `Pillow` | ะะฑัะฐะฑะพัะบะฐ ะธะทะพะฑัะฐะถะตะฝะธะน |
| Env | `python-dotenv` | ะกะตะบัะตัะฝัะต ะฟะตัะตะผะตะฝะฝัะต |

**ะัะตะณะพ ~7 ะทะฐะฒะธัะธะผะพััะตะน.** ะะตะท Redis, ะฑะตะท ะฑะฐะท ะดะฐะฝะฝัั, ะฑะตะท Docker.

---

## ๐ ะฃััะฐะฝะพะฒะบะฐ

### ะขัะตะฑะพะฒะฐะฝะธั ะบ ัะตัะฒะตัั

- Ubuntu 22.04+ ะธะปะธ Debian 12+
- NVIDIA GPU (RTX 3090 24GB ัะตะบะพะผะตะฝะดัะตััั)
- NVIDIA Driver 535+ ะธ CUDA 12.4+
- Python 3.10+
- ~50 GB ัะฒะพะฑะพะดะฝะพะณะพ ะผะตััะฐ (ะผะพะดะตะปะธ ~25 GB)

### ะััััะฐั ัััะฐะฝะพะฒะบะฐ (ะฒะตัั ัะตัะฒะตั)

```bash
# 1. ะะปะพะฝะธัะพะฒะฐัั ัะตะฟะพะทะธัะพัะธะน
git clone https://github.com/YOUR_USER/image-edit-bot.git /tmp/image-edit-bot
cd /tmp/image-edit-bot

# 2. ะะฐะฟัััะธัั ะฟะพะปะฝัั ัััะฐะฝะพะฒะบั (ะพั root)
sudo bash scripts/setup_server.sh
```

ะกะบัะธะฟั ะฒัะฟะพะปะฝะธั:
- ะฃััะฐะฝะพะฒะบั ัะธััะตะผะฝัั ะทะฐะฒะธัะธะผะพััะตะน
- ะกะพะทะดะฐะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั `comfyui` (ะฑะตะทะพะฟะฐัะฝะพััั โ ะฝะต ะพั root!)
- ะฃััะฐะฝะพะฒะบั ComfyUI + PyTorch + CUDA
- ะกะบะฐัะธะฒะฐะฝะธะต ะผะพะดะตะปะตะน (~25 GB)
- ะฃััะฐะฝะพะฒะบั ะบะฐััะพะผะฝัั ะฝะพะด ComfyUI
- ะฃััะฐะฝะพะฒะบั ะฑะพัะฐ ะธ ะทะฐะฒะธัะธะผะพััะตะน
- ะะฐัััะพะนะบั systemd ัะตัะฒะธัะพะฒ

### ะะพัะปะต ัััะฐะฝะพะฒะบะธ

```bash
# 3. ะะฐัััะพะธัั ัะพะบะตะฝ ะฑะพัะฐ
sudo -u comfyui nano /opt/image-edit-bot/.env
# โ ะฒะฟะธัะฐัั TELEGRAM_BOT_TOKEN (ะฟะพะปััะธัั ั @BotFather)

# 4. ะะฐะฟัััะธัั ComfyUI
sudo systemctl start comfyui
# ะะพะดะพะถะดะฐัั ~60 ัะตะบ ะฟะพะบะฐ ะผะพะดะตะปั ะทะฐะณััะทะธััั ะฒ VRAM

# 5. ะัะพะฒะตัะธัั ComfyUI
curl http://127.0.0.1:8188/system_stats

# 6. ะะฐะฟัััะธัั ะฑะพัะฐ
sudo systemctl start telegram-bot

# 7. ะัะพะฒะตัะธัั ะปะพะณะธ
sudo journalctl -u telegram-bot -f
```

---

## ๐ ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะฑะพัะฐ

### ะะพะผะฐะฝะดั

| ะะพะผะฐะฝะดะฐ | ะะฟะธัะฐะฝะธะต |
|---------|----------|
| `/start` | ะะฐัะฐัั ัะฐะฑะพัั |
| `/new` | ะกะพะทะดะฐัั ะฝะพะฒัั ะทะฐะดะฐัั |
| `/settings` | ะะฐัััะพะธัั ะฟะฐัะฐะผะตััั (steps, seed, cfg...) |
| `/status` | ะกัะฐััั ะพัะตัะตะดะธ |
| `/cancel` | ะัะผะตะฝะธัั ะทะฐะดะฐัั |
| `/help` | ะะพะผะพัั |

### ะัะพััะพะน ัะตะถะธะผ

```
1. ะัะฟัะฐะฒััะต /new
2. ะัะฟัะฐะฒััะต ัะพัะพ (ะธะปะธ ะดะพะบัะผะตะฝั ะดะปั ะฟะพะปะฝะพะณะพ ะบะฐัะตััะฒะฐ)
3. ะะฐะฟะธัะธัะต ะฟัะพะผะฟั: "remove background"
4. ะะพะถะดะธัะตัั ัะตะทัะปััะฐัะฐ
```

### ะก ะฝะฐัััะพะนะบะฐะผะธ

```
1. ะัะฟัะฐะฒััะต /settings โ ะฝะฐัััะพะนัะต steps, seed, cfg ัะตัะตะท ะบะฝะพะฟะบะธ
2. ะัะฟัะฐะฒััะต /new โ ัะพัะพ โ ะฟัะพะผะฟั
3. ะะพั ะพะฑัะฐะฑะพัะฐะตั ั ะฒะฐัะธะผะธ ะฟะฐัะฐะผะตััะฐะผะธ
```

---

## โ๏ธ ะะพะฝัะธะณััะฐัะธั

### `.env` โ ัะตะบัะตัั (ะะ ะฒ Git)

```bash
TELEGRAM_BOT_TOKEN=your_token_here
ADMIN_USER_IDS=123456789
COMFYUI_HOST=127.0.0.1
COMFYUI_PORT=8188
```

### `config.yaml` โ ะฟะฐัะฐะผะตััั

```yaml
workflow:
  defaults:
    steps: 8
    cfg: 1.0
    sampler: "linear/euler"
    scheduler: "simple"
    seed: 0          # 0 = random
    negative_prompt: "ugly, blurry, distorted, artifacts"
    
queue:
  max_size: 100
  timeout_seconds: 300
  
storage:
  cleanup_after_hours: 24
```

---

## ๐ง ะฃะฟัะฐะฒะปะตะฝะธะต ัะตัะฒะตัะพะผ

```bash
# ะกัะฐััั ัะตัะฒะธัะพะฒ
sudo systemctl status comfyui
sudo systemctl status telegram-bot

# ะะพะณะธ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
sudo journalctl -u comfyui -f
sudo journalctl -u telegram-bot -f

# ะะตัะตะทะฐะฟััะบ ะฑะพัะฐ (ะฟะพัะปะต git pull)
cd /opt/image-edit-bot
sudo -u comfyui git pull origin main
sudo systemctl restart telegram-bot

# ะะตัะตะทะฐะฟััะบ ComfyUI
sudo systemctl restart comfyui

# ะััะฐะฝะพะฒะธัั ะฒัั
sudo systemctl stop telegram-bot
sudo systemctl stop comfyui
```

---

## ๐ ะะพะดะตะปะธ

| ะะพะดะตะปั | ะะฐะทะผะตั | ะััะพัะฝะธะบ |
|--------|--------|----------|
| Qwen-Rapid-AIO-NSFW-v11.4 | ~13 GB | [HuggingFace](https://huggingface.co/Phr00t/Qwen-Image-Edit-Rapid-AIO) |
| qwen_2.5_vl_7b_fp8_scaled | ~7.5 GB | [HuggingFace](https://huggingface.co/Comfy-Org/Qwen-Image_ComfyUI) |
| qwen_image_vae | ~160 MB | [HuggingFace](https://huggingface.co/Comfy-Org/Qwen-Image_ComfyUI) |
| next-scene_lora-v2-3000 | ~200 MB | ะกะบะฐัะฐัั ะพัะดะตะปัะฝะพ |

ะะฐัะฟะพะปะพะถะตะฝะธะต ะฝะฐ ัะตัะฒะตัะต:
```
/opt/ComfyUI/models/
โโโ checkpoints/    โ Qwen-Rapid-AIO-NSFW-v11.4.safetensors
โโโ text_encoders/  โ qwen_2.5_vl_7b_fp8_scaled.safetensors
โโโ vae/            โ qwen_image_vae.safetensors
โโโ loras/qwen_edit/ โ next-scene_lora-v2-3000.safetensors
```

---

## ๐ ะะตะทะพะฟะฐัะฝะพััั

- ComfyUI ัะปััะฐะตั **ัะพะปัะบะพ** `127.0.0.1` (ะฝะตะดะพัััะฟะตะฝ ะธะทะฒะฝะต)
- ะกะตัะฒะธัั ะทะฐะฟััะบะฐัััั ะพั ะฟะพะปัะทะพะฒะฐัะตะปั `comfyui` (ะฝะต root)
- `ProtectSystem=strict` โ ะทะฐะฟะธัั ัะพะปัะบะพ ะฒ ัะฐะฑะพัะธะต ะดะธัะตะบัะพัะธะธ
- `NoNewPrivileges=true` โ ะทะฐะฟัะตั ััะบะฐะปะฐัะธะธ ะฟัะธะฒะธะปะตะณะธะน
- Whitelist ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะฒ `.env` (`ADMIN_USER_IDS`)
- Rate limiting ะฝะฐ ะทะฐะฟัะพัั

---

## ๐ ะะพะบัะผะตะฝัะฐัะธั

| ะะพะบัะผะตะฝั | ะะฟะธัะฐะฝะธะต |
|----------|----------|
| [plans/ARCHITECTURE.md](plans/ARCHITECTURE.md) | ะััะธัะตะบัััะฐ, ะบะพะผะฟะพะฝะตะฝัั, ะดะธะฐะณัะฐะผะผั |
| [plans/TECHNICAL_SPECS.md](plans/TECHNICAL_SPECS.md) | ะกะฟะตัะธัะธะบะฐัะธะธ ะบะพะผะฟะพะฝะตะฝัะพะฒ ั ะบะพะดะพะผ |
| [plans/TODO_IMPLEMENTATION.md](plans/TODO_IMPLEMENTATION.md) | ะะพัะฐะณะพะฒัะน ะฟะปะฐะฝ ัะตะฐะปะธะทะฐัะธะธ |
| [plans/SERVER_SETUP.md](plans/SERVER_SETUP.md) | ะะพะปะฝะฐั ัััะฐะฝะพะฒะบะฐ ัะตัะฒะตัะฐ |

---

## ๐ ะะธัะตะฝะทะธั

MIT
